services:
  cubyz-server:
    # Use pre-built image from GHCR or build locally
    # image: ghcr.io/amerkuri/cubyz-server-docker:latest
    build:
      context: .
      dockerfile: Dockerfile
      # Uncomment and set build arguments as needed
      # args:
        # - GIT_REPO=https://github.com/PixelGuys/Cubyz
        # - GIT_REF=0.0.1
        # - USER_UID=1000
        # - USER_GID=1000
        # - RELEASE_BUILD=false
    container_name: cubyz-server
    ports:
      - "47649:47649/udp"
    labels:
      - "autoheal=true"
    volumes:
      # Persist world data
      - ./saves:/cubyz/saves:z
    environment:
      # Server configuration via environment variables
      CUBYZ_WORLD_NAME: world
    restart: unless-stopped
    stop_grace_period: 30s
    # Resource limits (optional, adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f Cubyz && nc -uz -w1 127.0.0.1 47649 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  autoheal:
    image: docker.io/willfarrell/autoheal:latest
    container_name: autoheal
    restart: always
    environment:
      - AUTOHEAL_CONTAINER_LABEL=all
      - AUTOHEAL_INTERVAL=10
      - AUTOHEAL_START_PERIOD=30
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
