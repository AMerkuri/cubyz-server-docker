name: Cleanup PR Images

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Delete PR image from GHCR
        uses: actions/delete-package-versions@v5
        with:
          package-name: ${{ github.event.repository.name }}
          package-type: container
          min-versions-to-keep: 0
          delete-only-pre-release-versions: false
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Cleanup PR image via API
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          PACKAGE_NAME: ${{ github.event.repository.name }}
          PR_TAG: pr-${{ github.event.pull_request.number }}
        run: |
          echo "Looking for package versions with tag: $PR_TAG"

          # Get all versions of the package
          VERSIONS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/users/$OWNER/packages/container/$PACKAGE_NAME/versions" \
            --paginate 2>/dev/null || echo "[]")

          # Find version IDs with matching PR tag
          VERSION_IDS=$(echo "$VERSIONS" | jq -r ".[] | select(.metadata.container.tags[] == \"$PR_TAG\") | .id")

          if [ -z "$VERSION_IDS" ]; then
            echo "No versions found with tag $PR_TAG"
            exit 0
          fi

          # Delete each matching version
          for VERSION_ID in $VERSION_IDS; do
            echo "Deleting version ID: $VERSION_ID"
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/users/$OWNER/packages/container/$PACKAGE_NAME/versions/$VERSION_ID" \
              && echo "Successfully deleted version $VERSION_ID" \
              || echo "Failed to delete version $VERSION_ID (may already be deleted)"
          done
